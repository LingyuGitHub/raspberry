#include <stdio.h>
#include <string.h>
#include <errno.h>

#include <wiringPi.h>
#include <wiringSerial.h>


typedef unsigned char u8;
typedef unsigned short u16;

u16 ubx_checksum(u8 *arr, int len)
{
    int i = 0;
    u8 ck_a = 0x00, ck_b = 0x00;
    u16 res = 0x0000;
    for (i = 0; i < len; i++)
    {
        ck_a += arr[i];
        ck_b += ck_a;
    }
    arr[len] = ck_a;
    arr[len + 1] = ck_b;
    res = (ck_a << 8) + ck_b;
    return res;
}

u8 enagga[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x00,0x00,0x01,0x00,0x00,0xFE,0x18 };//  使能GGA  
u8 disgga[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0xFD,0x15 };//  取消GGA   
u8 enagll[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x01,0x00,0x01,0x00,0x00,0xFF,0x1D };//  使能GLL  
u8 disgll[] = { 0xB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x01,0x00,0x00,0x00,0x00,0xFE,0x1A };//  取消GLL  
u8 enagsa[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x02,0x00,0x01,0x00,0x00,0x00,0x22 };//  使能GSA  
u8 disgsa[] = { 0xB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x02,0x00,0x00,0x00,0x00,0xFF,0x1F };//  取消GSA  
u8 enagsv[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x03,0x00,0x01,0x00,0x00,0x01,0x27 };//  使能GSV   
u8 disgsv[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x03,0x00,0x00,0x00,0x00,0x00,0x24 };//  取消GSV  
u8 enarmc[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x04,0x00,0x01,0x00,0x00,0x02,0x2C };//  使能RMC   
u8 disrmc[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x04,0x00,0x00,0x00,0x00,0x01,0x29 };//  取消RMC  
u8 enavtg[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x05,0x00,0x01,0x00,0x00,0x03,0x31 };//  使能VTG   
u8 disvtg[] = { 0xB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x05,0x00,0x00,0x00,0x00,0x02,0x2E };//  取消VTG 
u8 enagrs[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x06,0x00,0x01,0x00,0x00,0x04,0x36 };//  使能GRS  
u8 disgrs[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x06,0x00,0x00,0x00,0x00,0x03,0x33 };//  取消GRS 
u8 enagst[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x07,0x00,0x01,0x00,0x00,0x05,0x3B };//  使能GST 
u8 disgst[] = { 0xB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x07,0x00,0x00,0x00,0x00,0x04,0x38 };//  取消GST  
u8 enazda[] = { 0xB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x08,0x00,0x01,0x00,0x00,0x06,0x40 };//  使能ZDA  
u8 diszda[] = { 0XB5,0x62,0x06,0x01,0x06,0x00,0xF0,0x08,0x00,0x00,0x00,0x00,0x05,0x3D };//  取消ZDA  

u8 ena1[] = { 0xb5, 0x62, 0x06, 0x01, 0x08, 0x00, 0x03, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x23, 0x2e };
u8 ena2[] = { 0xb5, 0x62, 0x06, 0x01, 0x08, 0x00, 0x03, 0x0f, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x22, 0x27 };
u8 ena3[] = { 0xb5, 0x62, 0x06, 0x01, 0x08, 0x00, 0x01, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x31, 0x8e };
int main()
{
    int fd;
    int res = 0, flag = 0;
    int i = 0;
    u16 ck_ab = 0x0000;
    if ((fd = serialOpen("/dev/ttyAMA0", 9600)) < 0)
    {
        fprintf(stderr, "Unable to open serial device: %s\n", strerror(errno));
        return 1;
    }

    if (wiringPiSetup() == -1)
    {
        fprintf(stdout, "Unable to start wiringPi: %s\n", strerror(errno));
        return 1;
    }

    //ck_ab=ubx_checksum(&enaraw[2], 10);
    //fprintf(stdout,"%04x\n", ck_ab);
    for (i = 0; i < sizeof(ena1) / sizeof(u8); i++)
    {
        serialPutchar(fd, ena1[i]);
    }
    for (i = 0; i < sizeof(ena2) / sizeof(u8); i++)
    {
        serialPutchar(fd, ena2[i]);
    }
    for (i = 0; i < sizeof(ena3) / sizeof(u8); i++)
    {
        serialPutchar(fd, ena3[i]);
    }
    for (i = 0; i < sizeof(enagsv) / sizeof(u8); i++)
    {
        serialPutchar(fd, enagsv[i]);
    }
    for (i = 0; i < sizeof(enagll) / sizeof(u8); i++)
    {
        serialPutchar(fd, enagll[i]);
    }
    for (i = 0; i < sizeof(enagga) / sizeof(u8); i++)
    {
        serialPutchar(fd, enagga[i]);
    }
    for (i = 0; i < sizeof(enavtg) / sizeof(u8); i++)
    {
        serialPutchar(fd, enavtg[i]);
    }
    for (i = 0; i < sizeof(enarmc) / sizeof(u8); i++)
    {
        serialPutchar(fd, enarmc[i]);
    }
    for (i = 0; i < sizeof(enagsa) / sizeof(u8); i++)
    {
        serialPutchar(fd, enagsa[i]);
    }
    fprintf(stdout, "ok\n");

    for (;;)
    {
        res = serialGetchar(fd);
        if (res == 0xb5)
        {
            fprintf(stdout, "\n");
            flag = 1;
        }
        if (flag == 1 && res == '$')
            break;
        else if (flag == 1)
            fprintf(stdout, "%02x ", res);
        fflush(stdout);
    }
    printf("\n");
    return 0;
}
